MAKEFILE_PATH   := $(lastword $(MAKEFILE_LIST))
TOOL_INST       := $(shell taste-config --prefix)
OUTDIR          := $(dir $(MAKEFILE_PATH))/build
SRCDIR          := $(dir $(MAKEFILE_PATH))/src
ASN1_FILES      := $(wildcard $(SRCDIR)/*.asn) 
ACN_FILES       := $(wildcard $(SRCDIR)/*.acn) 
DATAVIEW_PATH   := ${OUTDIR}/dataview
DATAVIEW_UNIQ   := ${DATAVIEW_PATH}/dataview-uniq.asn
DATAVIEW_ACN    := ${DATAVIEW_PATH}/dataview-uniq.acn
DATAVIEW_AADLV1 := ${DATAVIEW_PATH}/dataview_aadlv1.aadl

# Project cache folder is used to speed up all ASN.1-related processing
export PROJECT_CACHE=${HOME}/.taste_AST_cache

all:	build-default

# Generate the language-specific data view needed before editing user code
dataview:	${DATAVIEW_PATH}/C/built ${DATAVIEW_PATH}/Ada/built ${DATAVIEW_PATH}/Python/built

# Generate the complete dataview in Ada, C, C++, and including Python bindings
${DATAVIEW_PATH}/built:	dataview 
	touch $@

# The parallel invocation can not be added here because of matlab remote error
# For local matlab instalation it can be added
build-default:	${DATAVIEW_PATH}/built 

# Optionally manage SQL Database (run taste-create-database to enable)
sql_db/DV.py:
	mkdir -p sql_db && touch $@

# Create dataview-uniq.asn by concatenating all asn1 input files
${DATAVIEW_UNIQ}:	${ASN1_FILES}
	mkdir -p ${PROJECT_CACHE} && mkdir -p ${DATAVIEW_PATH}
	sed -e '$$s/$$/\n/' -s $^ > $@

# Create dataview-uniq.acn by concatenating all input files
${DATAVIEW_ACN}:	${ACN_FILES}
	mkdir -p ${DATAVIEW_PATH}
	sed -e '$$s/$$/\n/' -s $^ > $@

# Build dataview.aadl in AADLv1 format, used by DMT to generate glue code
${DATAVIEW_AADLV1}: ${DATAVIEW_UNIQ}
	asn2aadlPlus  $< $@

# Wrappers for GS, required to generate SQL tables
# gs/GUI/wrappers/aadl2glueC_built: gs/GUI/wrappers/gs_mini_cv.aadl ${DATAVIEW_AADLV1}
gs/GUI/wrappers/aadl2glueC_built: ${DATAVIEW_AADLV1}
	mkdir -p $(dir $@)
	aadl2glueC -allboards -o $(dir $@) $^
	touch $@

# -----------------------------------
# -- Compile the ASN.1 models in C --
# -----------------------------------

${DATAVIEW_PATH}/C/built: ${DATAVIEW_UNIQ} ${DATAVIEW_ACN}
	mkdir -p $(dir $@)
	# asn2dataModel does not take the ACN files, and only calls asn1scc
	# asn2dataModel -o $(dir $@) -toC ${DATAVIEW_UNIQ} ${DATAVIEW_ACN}
	asn1scc -typePrefix asn1Scc ${ASN1SCC_FLAGS} -renamePolicy 3 -equal -fp AUTO -o $(dir $@) -c -uPER -ACN $^
	cp ${TOOL_INST}/share/AutoGUI/debug_messages.? ${DATAVIEW_PATH}/C
	cp ${TOOL_INST}/share/AutoGUI/timeInMS.? ${DATAVIEW_PATH}/C
	cd ${DATAVIEW_PATH}/C && msgPrinterASN1 ../dataview-uniq.asn
	touch $@

# -------------------------------------------------------------------
# -- Compile the ASN.1 models in Python for the autogenerated GUIs --
# -------------------------------------------------------------------

${DATAVIEW_PATH}/Python/built:	${DATAVIEW_PATH}/C/built gs/GUI/wrappers/aadl2glueC_built sql_db/DV.py
	mkdir -p $(dir $@)
	mkdir -p gs/GUI/wrappers/python
	asn2dataModel -o $(dir $@) -toPython ${DATAVIEW_UNIQ}
	$(MAKE) -C ${DATAVIEW_PATH}/Python -f Makefile.python
	cp ${DATAVIEW_PATH}/Python/* gs/GUI/wrappers/python
	cp ${DATAVIEW_PATH}/C/timeInMS.[ch] ${DATAVIEW_PATH}/C/debug_messages.[ch] gs/GUI/wrappers/python	
	cd gs/GUI/wrappers/python && \
	   #gcc -g -fPIC -c  gui_api.c ../../src/queue_manager.c timeInMS.c debug_messages.c -I. -I../../src && \
	   gcc -g -fPIC -c  timeInMS.c debug_messages.c -I. -I../../src && \
	   gcc -g -shared -o PythonAccess.so timeInMS.o debug_messages.o -lrt
	mkdir -p binaries/gs_GUI
	cp -f gs/GUI/wrappers/python/* binaries/gs_GUI
	#cp -f gs/GUI/wrappers/*.py binaries/gs_GUI
	#cp -f gs/GUI/wrappers/*.ui binaries/gs_GUI
	echo "errCodes = \\" >> binaries/gs_GUI/datamodel.py
	taste-asn1-errCodes binaries/gs_GUI/dataview-uniq.h >> binaries/gs_GUI/datamodel.py
	if [ -f sql_db/db.info ]; then cd binaries/gs_GUI && ln -fs ../../sql_db; fi
	#  Interface view must be placed in the gui folder to allow replaying MSCs
	#cp -u ../InterfaceView.aadl binaries/gs_GUI
	touch $@

# -------------------------------------
# -- Compile the ASN.1 models in Ada --
# -------------------------------------

${DATAVIEW_PATH}/Ada/built: ${DATAVIEW_UNIQ}
	mkdir -p $(dir $@)
	asn2dataModel -allboards -o $(dir $@) -toAda $^
	touch $@
	cd ${DATAVIEW_PATH}/Ada && rm -f gnat.cfg GPS_project.gpr IgnoredExaminerWarnings.wrn runSpark.sh

clean:
	rm -rf binaries ${DATAVIEW_PATH} 
	$(MAKE) -C build -f Makefile.taste clean

.PHONY: clean simu compile-all-linux function-instances-linux function-types-linux build-default dataview build-rtems-ada dataview build/modelchecking modelchecking/subtypes/$(SUBTYPE) obs-to-if aadl-to-if asn-to-if $(PROPERTIES_CONFIG) run_cv

